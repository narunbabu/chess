<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Bracket Visualizer v2 - With Standings & Rankings</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .config-selector {
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .config-selector:hover {
            background: #667eea;
            color: white;
        }

        .reset-btn, .export-btn, .standings-btn {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .reset-btn {
            background: #e74c3c;
            color: white;
        }

        .reset-btn:hover {
            background: #c0392b;
        }

        .export-btn {
            background: #2ecc71;
            color: white;
        }

        .export-btn:hover {
            background: #27ae60;
        }

        .standings-btn {
            background: #3498db;
            color: white;
        }

        .standings-btn:hover {
            background: #2980b9;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }

        /* Standings Table */
        .standings-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            display: none;
        }

        .standings-section.show {
            display: block;
        }

        .standings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .standings-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .standings-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .standings-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .standings-table th,
        .standings-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .standings-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
        }

        .standings-table tr:hover {
            background: #f0f7ff;
        }

        .standings-table tr:last-child td {
            border-bottom: none;
        }

        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            font-weight: bold;
            color: white;
        }

        .rank-1 { background: #FFD700; color: #333; }
        .rank-2 { background: #C0C0C0; color: #333; }
        .rank-3 { background: #CD7F32; color: white; }
        .rank-other { background: #95a5a6; }

        .rounds-container {
            display: flex;
            gap: 30px;
            overflow-x: auto;
            padding: 20px 0;
        }

        .round {
            min-width: 320px;
            flex-shrink: 0;
        }

        .round.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .round-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            font-size: 18px;
            position: relative;
        }

        .round-type {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .lock-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
        }

        .matches {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 0 0 8px 8px;
            border: 2px solid #e0e0e0;
            border-top: none;
        }

        .match {
            background: white;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .match:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .match:last-child {
            margin-bottom: 0;
        }

        .match-header {
            background: #3498db;
            color: white;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .player {
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #e0e0e0;
        }

        .player:last-child {
            border-bottom: none;
        }

        .player:hover {
            background: #f0f7ff;
        }

        .player.winner {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .player.loser {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .player-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .player-name {
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }

        .player-rating {
            font-size: 12px;
            color: #666;
        }

        .winner-badge {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .podium {
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            border-radius: 12px;
            color: white;
        }

        .podium h2 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 28px;
        }

        .podium-places {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            margin-top: 30px;
        }

        .podium-place {
            text-align: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .podium-place.first {
            order: 2;
            transform: scale(1.1);
        }

        .podium-place.second {
            order: 1;
        }

        .podium-place.third {
            order: 3;
        }

        .medal {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .place-name {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .place-player {
            font-size: 20px;
            font-weight: bold;
        }

        /* Final Rankings Table */
        .final-rankings {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .final-rankings h3 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .bye-match {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }

        .bye-match .player {
            cursor: default;
        }

        .bye-match .player:hover {
            background: #fff3cd;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .active-round .round-header {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ Tournament Bracket Visualizer v2</h1>
        <p class="subtitle">Enhanced with Standings Tracking & Full Rankings - Click on players to set winners</p>

        <div class="controls">
            <select id="configSelector" class="config-selector">
                <option value="">Select Tournament Configuration...</option>
            </select>
            <button id="standingsBtn" class="standings-btn">üìä Toggle Standings</button>
            <button id="resetBtn" class="reset-btn">üîÑ Reset Winners</button>
            <button id="exportBtn" class="export-btn">üíæ Export Results</button>
        </div>

        <div class="stats" id="stats"></div>

        <!-- Current Standings Section -->
        <div class="standings-section" id="standingsSection">
            <div class="standings-header">
                <div class="standings-title">üìä Current Standings</div>
            </div>
            <div class="standings-table">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Points</th>
                            <th>W-L-D</th>
                            <th>Matches</th>
                            <th>Rating</th>
                        </tr>
                    </thead>
                    <tbody id="standingsTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="loading" class="loading">
            Select a tournament configuration to begin...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div class="rounds-container" id="roundsContainer" style="display: none;"></div>

        <div class="podium" id="podium" style="display: none;">
            <h2>üèÜ Tournament Results</h2>
            <div class="podium-places" id="podiumPlaces"></div>

            <!-- Final Rankings Table -->
            <div class="final-rankings">
                <h3>üìã Final Rankings (All Players)</h3>
                <div class="standings-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>Points</th>
                                <th>W-L-D</th>
                                <th>Matches</th>
                                <th>Final Position</th>
                            </tr>
                        </thead>
                        <tbody id="finalRankingsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTournament = null;
        let matchResults = {};
        let currentStandings = [];

        // Load tournament configurations
        async function loadConfigurations() {
            try {
                const response = await fetch('tournament_tests_all.json');
                const data = await response.json();

                const selector = document.getElementById('configSelector');
                data.forEach((config, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${config.config_name} (${config.player_count} players, ${config.rounds.length} rounds)`;
                    selector.appendChild(option);
                });

                selector.addEventListener('change', (e) => {
                    if (e.target.value !== '') {
                        loadTournament(data[e.target.value]);
                    }
                });
            } catch (error) {
                showError('Failed to load tournament configurations: ' + error.message);
            }
        }

        function loadTournament(tournament) {
            currentTournament = tournament;
            matchResults = {};

            // Initialize standings from initial_standings if available
            if (tournament.initial_standings) {
                currentStandings = JSON.parse(JSON.stringify(tournament.initial_standings));
            } else {
                // Fallback: create initial standings
                currentStandings = tournament.participants.map((p, index) => ({
                    rank: index + 1,
                    player_id: p.id,
                    player_name: p.name,
                    rating: p.rating,
                    points: 0,
                    wins: 0,
                    losses: 0,
                    draws: 0,
                    matches_played: 0
                }));
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('roundsContainer').style.display = 'flex';

            renderStats();
            renderRounds();
            updateRoundActivation();
            updateStandingsDisplay();
        }

        function renderStats() {
            const stats = document.getElementById('stats');
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Players</div>
                    <div class="stat-value">${currentTournament.player_count}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Rounds</div>
                    <div class="stat-value">${currentTournament.rounds.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Matches</div>
                    <div class="stat-value">${currentTournament.summary.total_matches}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Matches Completed</div>
                    <div class="stat-value" id="completedCount">0</div>
                </div>
            `;
        }

        function renderRounds() {
            const container = document.getElementById('roundsContainer');
            container.innerHTML = '';

            currentTournament.rounds.forEach((round) => {
                const roundDiv = document.createElement('div');
                roundDiv.className = 'round';
                roundDiv.id = `round-${round.round_number}`;

                const lockIcon = round.round_number === 1 ? '' : '<span class="lock-icon">üîí</span>';

                roundDiv.innerHTML = `
                    <div class="round-header">
                        ${round.name}
                        <div class="round-type">${round.type}</div>
                        ${lockIcon}
                    </div>
                    <div class="matches" id="matches-${round.round_number}">
                        ${renderMatches(round)}
                    </div>
                `;

                container.appendChild(roundDiv);
            });
        }

        function renderMatches(round) {
            return round.matches.map((match, index) => {
                const isBye = !match.player2;
                const matchClass = isBye ? 'match bye-match' : 'match';

                return `
                    <div class="${matchClass}" data-match-id="${match.id}">
                        <div class="match-header">Match ${index + 1}</div>
                        ${renderPlayer(match, match.player1, 'player1', isBye)}
                        ${match.player2 ? renderPlayer(match, match.player2, 'player2', isBye) : '<div class="player bye-match"><span>BYE</span></div>'}
                    </div>
                `;
            }).join('');
        }

        function renderPlayer(match, player, playerKey, isBye) {
            if (!player) return '';

            const matchResult = matchResults[match.id];
            const isWinner = matchResult === player.id;
            const isLoser = matchResult && matchResult !== player.id;

            let classes = 'player';
            if (isWinner) classes += ' winner';
            if (isLoser) classes += ' loser';

            const badge = isWinner ? '<span class="winner-badge">WINNER</span>' : '';

            return `
                <div class="${classes}" data-match-id="${match.id}" data-player-id="${player.id}" onclick="selectWinner(${match.id}, ${player.id}, ${isBye})">
                    <div class="player-info">
                        <div class="player-name">${player.name}</div>
                        <div class="player-rating">Rating: ${player.rating}</div>
                    </div>
                    ${badge}
                </div>
            `;
        }

        function selectWinner(matchId, playerId, isBye) {
            if (isBye) return;

            // Toggle winner selection
            if (matchResults[matchId] === playerId) {
                delete matchResults[matchId];
            } else {
                matchResults[matchId] = playerId;
            }

            // Update standings
            calculateStandings();

            renderRounds();
            updateRoundActivation();
            updateCompletedCount();
            updateStandingsDisplay();
            checkTournamentCompletion();
        }

        function calculateStandings() {
            // Reset all standings
            currentStandings.forEach(s => {
                s.points = 0;
                s.wins = 0;
                s.losses = 0;
                s.draws = 0;
                s.matches_played = 0;
            });

            // Calculate from match results
            currentTournament.rounds.forEach(round => {
                round.matches.forEach(match => {
                    const winnerId = matchResults[match.id];
                    if (!winnerId) return;

                    const loserId = winnerId === match.player1.id ? match.player2?.id : match.player1.id;

                    // Update winner
                    const winnerStanding = currentStandings.find(s => s.player_id === winnerId);
                    if (winnerStanding) {
                        winnerStanding.points += 1;
                        winnerStanding.wins += 1;
                        winnerStanding.matches_played += 1;
                    }

                    // Update loser
                    if (loserId) {
                        const loserStanding = currentStandings.find(s => s.player_id === loserId);
                        if (loserStanding) {
                            loserStanding.losses += 1;
                            loserStanding.matches_played += 1;
                        }
                    }
                });
            });

            // Sort by points, then by rating
            currentStandings.sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                return b.rating - a.rating;
            });

            // Update ranks
            currentStandings.forEach((s, index) => {
                s.rank = index + 1;
            });
        }

        function updateStandingsDisplay() {
            const tbody = document.getElementById('standingsTableBody');
            tbody.innerHTML = '';

            currentStandings.forEach(standing => {
                const rankClass = standing.rank === 1 ? 'rank-1' :
                                 standing.rank === 2 ? 'rank-2' :
                                 standing.rank === 3 ? 'rank-3' : 'rank-other';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="rank-badge ${rankClass}">${standing.rank}</span></td>
                    <td><strong>${standing.player_name}</strong></td>
                    <td><strong>${standing.points}</strong></td>
                    <td>${standing.wins}-${standing.losses}-${standing.draws}</td>
                    <td>${standing.matches_played}</td>
                    <td>${standing.rating}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateRoundActivation() {
            currentTournament.rounds.forEach((round, index) => {
                const roundDiv = document.getElementById(`round-${round.round_number}`);

                if (index === 0) {
                    roundDiv.classList.remove('disabled');
                    roundDiv.classList.add('active-round');
                } else {
                    const previousRound = currentTournament.rounds[index - 1];
                    const previousRoundComplete = isRoundComplete(previousRound);

                    if (previousRoundComplete) {
                        roundDiv.classList.remove('disabled');

                        const currentRoundComplete = isRoundComplete(round);
                        if (!currentRoundComplete) {
                            roundDiv.classList.add('active-round');
                        } else {
                            roundDiv.classList.remove('active-round');
                        }

                        const lockIcon = roundDiv.querySelector('.lock-icon');
                        if (lockIcon) {
                            lockIcon.textContent = 'üîì';
                        }
                    } else {
                        roundDiv.classList.add('disabled');
                        roundDiv.classList.remove('active-round');
                    }
                }
            });
        }

        function isRoundComplete(round) {
            return round.matches.every(match => {
                if (!match.player2) return true; // Bye matches
                return matchResults[match.id] !== undefined;
            });
        }

        function updateCompletedCount() {
            const completedMatches = Object.keys(matchResults).length;
            const byeMatches = currentTournament.rounds.reduce((count, round) => {
                return count + round.matches.filter(m => !m.player2).length;
            }, 0);

            document.getElementById('completedCount').textContent = completedMatches + byeMatches;
        }

        function checkTournamentCompletion() {
            const allRoundsComplete = currentTournament.rounds.every(isRoundComplete);

            if (allRoundsComplete) {
                displayPodium();
            } else {
                document.getElementById('podium').style.display = 'none';
            }
        }

        function displayPodium() {
            const podium = document.getElementById('podium');
            const podiumPlaces = document.getElementById('podiumPlaces');

            // Get final results
            const finalRound = currentTournament.rounds[currentTournament.rounds.length - 1];
            const finalMatch = finalRound.matches[0];

            const winnerId = matchResults[finalMatch.id];
            const runnerUpId = winnerId === finalMatch.player1.id ? finalMatch.player2.id : finalMatch.player1.id;

            // Find third place from third place match if it exists
            let thirdPlaceId = null;
            let fourthPlaceId = null;

            const thirdPlaceRound = currentTournament.rounds.find(r => r.type === 'third_place');
            if (thirdPlaceRound && thirdPlaceRound.matches.length > 0) {
                const thirdPlaceMatch = thirdPlaceRound.matches[0];
                thirdPlaceId = matchResults[thirdPlaceMatch.id];
                fourthPlaceId = thirdPlaceId === thirdPlaceMatch.player1.id ?
                               thirdPlaceMatch.player2.id : thirdPlaceMatch.player1.id;
            }

            const winner = currentTournament.participants.find(p => p.id === winnerId);
            const runnerUp = currentTournament.participants.find(p => p.id === runnerUpId);
            const thirdPlace = thirdPlaceId ? currentTournament.participants.find(p => p.id === thirdPlaceId) : null;

            podiumPlaces.innerHTML = `
                <div class="podium-place first">
                    <div class="medal">ü•á</div>
                    <div class="place-name">Champion</div>
                    <div class="place-player">${winner.name}</div>
                </div>
                <div class="podium-place second">
                    <div class="medal">ü•à</div>
                    <div class="place-name">Runner-up</div>
                    <div class="place-player">${runnerUp.name}</div>
                </div>
                ${thirdPlace ? `
                    <div class="podium-place third">
                        <div class="medal">ü•â</div>
                        <div class="place-name">Third Place</div>
                        <div class="place-player">${thirdPlace.name}</div>
                    </div>
                ` : ''}
            `;

            // Display full final rankings
            displayFinalRankings(winnerId, runnerUpId, thirdPlaceId, fourthPlaceId);

            podium.style.display = 'block';
        }

        function displayFinalRankings(winnerId, runnerUpId, thirdPlaceId, fourthPlaceId) {
            const tbody = document.getElementById('finalRankingsTableBody');
            tbody.innerHTML = '';

            // Create final standings with positions
            const finalStandings = currentStandings.map(s => ({...s}));

            // Assign positions based on tournament results
            finalStandings.forEach(standing => {
                if (standing.player_id === winnerId) {
                    standing.final_position = 'ü•á Champion';
                    standing.final_rank = 1;
                } else if (standing.player_id === runnerUpId) {
                    standing.final_position = 'ü•à Runner-up';
                    standing.final_rank = 2;
                } else if (standing.player_id === thirdPlaceId) {
                    standing.final_position = 'ü•â Third Place';
                    standing.final_rank = 3;
                } else if (standing.player_id === fourthPlaceId) {
                    standing.final_position = '4th Place';
                    standing.final_rank = 4;
                } else {
                    standing.final_position = `${standing.rank}th Place`;
                    standing.final_rank = standing.rank;
                }
            });

            // Sort by final rank
            finalStandings.sort((a, b) => a.final_rank - b.final_rank);

            finalStandings.forEach(standing => {
                const rankClass = standing.final_rank === 1 ? 'rank-1' :
                                 standing.final_rank === 2 ? 'rank-2' :
                                 standing.final_rank === 3 ? 'rank-3' : 'rank-other';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="rank-badge ${rankClass}">${standing.final_rank}</span></td>
                    <td><strong>${standing.player_name}</strong></td>
                    <td><strong>${standing.points}</strong></td>
                    <td>${standing.wins}-${standing.losses}-${standing.draws}</td>
                    <td>${standing.matches_played}</td>
                    <td>${standing.final_position}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function resetWinners() {
            if (confirm('Reset all winner selections?')) {
                matchResults = {};
                calculateStandings();
                renderRounds();
                updateRoundActivation();
                updateCompletedCount();
                updateStandingsDisplay();
                document.getElementById('podium').style.display = 'none';
            }
        }

        function exportResults() {
            const results = {
                tournament: currentTournament.config_name,
                player_count: currentTournament.player_count,
                match_results: matchResults,
                final_standings: currentStandings,
                rounds: currentTournament.rounds.map(round => ({
                    round_number: round.round_number,
                    name: round.name,
                    type: round.type,
                    complete: isRoundComplete(round)
                }))
            };

            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tournament_results_${currentTournament.player_count}_players.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function toggleStandings() {
            const standingsSection = document.getElementById('standingsSection');
            standingsSection.classList.toggle('show');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // Event listeners
        document.getElementById('resetBtn').addEventListener('click', resetWinners);
        document.getElementById('exportBtn').addEventListener('click', exportResults);
        document.getElementById('standingsBtn').addEventListener('click', toggleStandings);

        // Initialize
        loadConfigurations();
    </script>
</body>
</html>
