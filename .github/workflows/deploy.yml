name: Deploy to Production

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}   # <-- your private key (PEM), no passphrase
          port: 22
          script_stop: false
          script: |
            # Deployment script with robust error handling
            # Critical errors will be logged but won't fail the entire deployment

            set -e  # Exit on error for critical steps

            echo "ğŸš€ Starting deployment..."

            # ==================== GIT SYNC ====================
            echo ""
            echo "ğŸ“¦ Syncing code from repository..."
            cd /opt/Chess-Web
            git fetch origin
            git reset --hard origin/master
            echo "âœ… Code synced successfully"

            # ==================== BACKEND (Laravel) ====================
            echo ""
            echo "ğŸ”§ Deploying Laravel backend..."
            cd chess-backend

            # Allow composer to run as superuser (deployment context)
            export COMPOSER_ALLOW_SUPERUSER=1

            # Install dependencies with optimizations
            echo "ğŸ“¦ Installing Composer dependencies..."
            composer install --no-dev --optimize-autoloader --classmap-authoritative || {
              echo "âš ï¸  Composer install failed, continuing..."
            }

            # Run migrations (non-blocking)
            echo "ğŸ—„ï¸  Running database migrations..."
            php artisan migrate --force || {
              echo "âš ï¸  Migration failed or no new migrations"
            }

            # Clear Laravel caches
            echo "ğŸ§¹ Clearing Laravel caches..."
            php artisan config:clear || true
            php artisan route:clear || true
            php artisan cache:clear || true
            php artisan view:clear || true

            composer dump-autoload --optimize || true

            # Rebuild caches
            echo "âš¡ Rebuilding Laravel caches..."
            php artisan config:cache || true
            php artisan route:cache || true
            php artisan view:cache || true
            php artisan optimize || true

            # Restart queue workers
            php artisan queue:restart || {
              echo "â„¹ï¸  No queue workers running"
            }

            echo "âœ… Backend deployment complete"

            # ==================== FRONTEND (React) ====================
            echo ""
            echo "âš›ï¸  Deploying React frontend..."
            cd ../chess-frontend

            # Load NVM and use Node 20
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 20 || nvm install 20

            # Check if pnpm is available, otherwise use npm
            if command -v pnpm &> /dev/null; then
              echo "ğŸ“¦ Using pnpm for package management..."
              PKG_MANAGER="pnpm"
            else
              echo "ğŸ“¦ Using npm for package management..."
              PKG_MANAGER="npm"
            fi

            # Install dependencies
            echo "ğŸ“¦ Installing dependencies with $PKG_MANAGER..."
            if [ "$PKG_MANAGER" = "pnpm" ]; then
              pnpm install || {
                echo "âŒ pnpm install failed - this is critical!"
                exit 1
              }
            else
              # Clean npm cache if needed
              npm cache clean --force || true

              # Remove corrupted lock file and reinstall fresh
              if [ -f package-lock.json ]; then
                echo "ğŸ—‘ï¸  Removing old package-lock.json..."
                rm package-lock.json
              fi

              npm install || {
                echo "âŒ npm install failed - this is critical!"
                exit 1
              }
            fi

            # Verify react-scripts is installed
            if ! command -v react-scripts &> /dev/null && ! [ -f node_modules/.bin/react-scripts ]; then
              echo "âŒ react-scripts not found after install - critical error!"
              exit 1
            fi
            echo "âœ… Dependencies installed successfully"

            # Check for vulnerabilities (informational only)
            echo "ğŸ”’ Checking security..."
            if [ "$PKG_MANAGER" = "pnpm" ]; then
              pnpm audit || {
                echo "â„¹ï¸  Some vulnerabilities detected (informational only)"
              }
            else
              npm audit || {
                echo "â„¹ï¸  Some vulnerabilities detected (informational only)"
              }
            fi

            # Build with improved error handling and source map suppression
            echo "ğŸ—ï¸  Building React application..."
            export DISABLE_ESLINT_PLUGIN=true
            export CI=false
            export GENERATE_SOURCEMAP=false  # Suppress source map warnings

            if [ "$PKG_MANAGER" = "pnpm" ]; then
              pnpm run build || {
                echo "âŒ Build failed - this is critical!"
                exit 1
              }
            else
              npm run build || {
                echo "âŒ Build failed - this is critical!"
                exit 1
              }
            fi

            # Deploy frontend build to web server
            echo "ğŸ“¤ Deploying build to web server..."
            rsync -av --delete build/ /var/www/chess99.com/ || {
              echo "âŒ Rsync failed - this is critical!"
              exit 1  # This is a critical failure
            }

            echo "âœ… Frontend deployment complete"

            # ==================== PERMISSIONS ====================
            echo ""
            echo "ğŸ” Setting file permissions..."
            chown -R www-data:www-data /opt/Chess-Web/chess-backend/storage || true
            chown -R www-data:www-data /opt/Chess-Web/chess-backend/bootstrap/cache || true
            echo "âœ… Permissions updated"

            # ==================== NGINX CONFIGURATION ====================
            echo ""
            echo "ğŸ“ Updating nginx configuration..."
            cd /opt/Chess-Web

            # Disable exit-on-error for nginx config update (non-critical)
            set +e

            if [ -f nginx-api-fix.conf ]; then
              # Backup current config
              cp /etc/nginx/sites-available/api.chess99.com /etc/nginx/sites-available/api.chess99.com.backup-$(date +%Y%m%d-%H%M%S)

              # Copy new config
              cp nginx-api-fix.conf /etc/nginx/sites-available/api.chess99.com

              # Test nginx config
              if nginx -t 2>&1 | grep -q "successful"; then
                echo "âœ… Nginx configuration updated successfully"
              else
                echo "âš ï¸  Nginx configuration test failed, reverting..."
                LATEST_BACKUP=$(ls -t /etc/nginx/sites-available/api.chess99.com.backup-* 2>/dev/null | head -1)
                if [ -n "$LATEST_BACKUP" ]; then
                  cp "$LATEST_BACKUP" /etc/nginx/sites-available/api.chess99.com
                  echo "â†©ï¸  Reverted to previous configuration"
                fi
              fi
            else
              echo "âš ï¸  nginx-api-fix.conf not found, skipping nginx config update"
            fi

            # Re-enable exit-on-error
            set -e

            # ==================== SERVICE RESTART ====================
            echo ""
            echo "â™»ï¸  Restarting services..."

            # Disable exit-on-error for service restarts (may not all exist)
            set +e

            systemctl restart php8.3-fpm && echo "âœ… PHP-FPM restarted" || echo "âš ï¸  PHP-FPM restart failed"
            systemctl reload nginx && echo "âœ… Nginx reloaded" || echo "âš ï¸  Nginx reload failed"
            systemctl restart laravel-reverb && echo "âœ… Reverb restarted" || echo "â„¹ï¸  Reverb service not found"

            # ==================== SERVICE VERIFICATION ====================
            echo ""
            echo "ğŸ” Verifying service status..."

            NGINX_STATUS=$(systemctl is-active nginx 2>/dev/null || echo "inactive")
            PHP_STATUS=$(systemctl is-active php8.3-fpm 2>/dev/null || echo "inactive")
            REVERB_STATUS=$(systemctl is-active laravel-reverb 2>/dev/null || echo "inactive")

            if [ "$NGINX_STATUS" = "active" ]; then
              echo "âœ… Nginx is running"
            else
              echo "âŒ Nginx is not running"
            fi

            if [ "$PHP_STATUS" = "active" ]; then
              echo "âœ… PHP-FPM is running"
            else
              echo "âŒ PHP-FPM is not running"
            fi

            if [ "$REVERB_STATUS" = "active" ]; then
              echo "âœ… Laravel Reverb is running"
            else
              echo "â„¹ï¸  Laravel Reverb is not running (WebSockets disabled)"
            fi

            # ==================== CORS VERIFICATION ====================
            echo ""
            echo "ğŸ” Verifying CORS configuration..."

            CORS_CHECK=$(curl -s -I https://api.chess99.com/storage/ 2>/dev/null || echo "")

            if echo "$CORS_CHECK" | grep -q "Access-Control-Allow-Origin"; then
              echo "âœ… CORS headers are configured correctly"
            else
              echo "â„¹ï¸  CORS headers not detected (this may be normal if endpoint doesn't exist)"
            fi

            # ==================== DEPLOYMENT COMPLETE ====================
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment completed successfully!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""

            # Ensure script always exits with success (unless critical failure occurred)
            exit 0
