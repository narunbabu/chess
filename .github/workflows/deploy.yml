name: Deploy to Production

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}   # <-- your private key (PEM), no passphrase
          port: 22
          script_stop: false
          script: |
            # Optimized deployment script with conditional execution
            # Only runs backend/frontend deployments when files actually changed

            set -e  # Exit on error for critical steps

            echo "ğŸš€ Starting deployment..."

            # ==================== GIT SYNC ====================
            echo ""
            echo "ğŸ“¦ Syncing code from repository..."
            cd /opt/Chess-Web

            # Store the previous commit for comparison
            PREV_COMMIT=$(git rev-parse HEAD)

            git fetch origin
            git reset --hard origin/master

            # Detect what changed
            BACKEND_CHANGED=false
            FRONTEND_CHANGED=false

            if git diff --name-only $PREV_COMMIT HEAD | grep -q "^chess-backend/"; then
              BACKEND_CHANGED=true
              echo "ğŸ“‹ Backend files changed - will deploy backend"
            else
              echo "â„¹ï¸  No backend changes detected - skipping backend deployment"
            fi

            if git diff --name-only $PREV_COMMIT HEAD | grep -q "^chess-frontend/"; then
              FRONTEND_CHANGED=true
              echo "ğŸ“‹ Frontend files changed - will deploy frontend"
            else
              echo "â„¹ï¸  No frontend changes detected - skipping frontend deployment"
            fi

            echo "âœ… Code synced successfully"

            # ==================== BACKEND (Laravel) ====================
            if [ "$BACKEND_CHANGED" = true ]; then
              echo ""
              echo "ğŸ”§ Deploying Laravel backend..."
              cd chess-backend

              # Allow composer to run as superuser (deployment context)
              export COMPOSER_ALLOW_SUPERUSER=1

              # Install dependencies with optimizations
              echo "ğŸ“¦ Installing Composer dependencies..."
              composer install --no-dev --optimize-autoloader --classmap-authoritative || {
                echo "âš ï¸  Composer install failed, continuing..."
              }

              # Run migrations
              echo "ğŸ—„ï¸  Running database migrations..."
              php artisan migrate --force || {
                echo "âš ï¸  Migration failed or no new migrations"
              }

              # Clear and rebuild Laravel caches
              echo "ğŸ§¹ Clearing and rebuilding Laravel caches..."
              php artisan optimize:clear || true
              php artisan optimize || true

              # Restart queue workers
              php artisan queue:restart || {
                echo "â„¹ï¸  No queue workers running"
              }

              echo "âœ… Backend deployment complete"
              cd /opt/Chess-Web
            fi

            # ==================== FRONTEND (React) ====================
            if [ "$FRONTEND_CHANGED" = true ]; then
              echo ""
              echo "âš›ï¸  Deploying React frontend..."
              cd chess-frontend

              # Load NVM and use Node 20
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
              nvm use 20 || nvm install 20

              # Check if pnpm is available, otherwise use npm
              if command -v pnpm &> /dev/null; then
                echo "ğŸ“¦ Using pnpm for package management..."
                PKG_MANAGER="pnpm"
              else
                echo "ğŸ“¦ Using npm for package management..."
                PKG_MANAGER="npm"
              fi

              # Install dependencies
              echo "ğŸ“¦ Installing dependencies with $PKG_MANAGER..."
              if [ "$PKG_MANAGER" = "pnpm" ]; then
                pnpm install || {
                  echo "âŒ pnpm install failed - this is critical!"
                  exit 1
                }
              else
                npm install || {
                  echo "âŒ npm install failed - this is critical!"
                  exit 1
                }
              fi

              echo "âœ… Dependencies installed successfully"

              # Build React application
              echo "ğŸ—ï¸  Building React application..."
              export DISABLE_ESLINT_PLUGIN=true
              export CI=false
              export GENERATE_SOURCEMAP=false

              if [ "$PKG_MANAGER" = "pnpm" ]; then
                pnpm run build || {
                  echo "âŒ Build failed - this is critical!"
                  exit 1
                }
              else
                npm run build || {
                  echo "âŒ Build failed - this is critical!"
                  exit 1
                }
              fi

              # Deploy frontend build to web server
              echo "ğŸ“¤ Deploying build to web server..."
              rsync -av --delete build/ /var/www/chess99.com/ || {
                echo "âŒ Rsync failed - this is critical!"
                exit 1
              }

              echo "âœ… Frontend deployment complete"
              cd /opt/Chess-Web
            fi

            # ==================== PERMISSIONS ====================
            if [ "$BACKEND_CHANGED" = true ]; then
              echo ""
              echo "ğŸ” Setting file permissions..."
              chown -R www-data:www-data /opt/Chess-Web/chess-backend/storage || true
              chown -R www-data:www-data /opt/Chess-Web/chess-backend/bootstrap/cache || true
              echo "âœ… Permissions updated"
            fi

            # ==================== NGINX CONFIGURATION ====================
            echo ""
            echo "ğŸ“ Updating nginx configuration..."
            cd /opt/Chess-Web

            # Disable exit-on-error for nginx config update (non-critical)
            set +e

            if [ -f nginx-api-fix.conf ]; then
              # Backup current config
              cp /etc/nginx/sites-available/api.chess99.com /etc/nginx/sites-available/api.chess99.com.backup-$(date +%Y%m%d-%H%M%S)

              # Copy new config
              cp nginx-api-fix.conf /etc/nginx/sites-available/api.chess99.com

              # Test nginx config
              if nginx -t 2>&1 | grep -q "successful"; then
                echo "âœ… Nginx configuration updated successfully"
              else
                echo "âš ï¸  Nginx configuration test failed, reverting..."
                LATEST_BACKUP=$(ls -t /etc/nginx/sites-available/api.chess99.com.backup-* 2>/dev/null | head -1)
                if [ -n "$LATEST_BACKUP" ]; then
                  cp "$LATEST_BACKUP" /etc/nginx/sites-available/api.chess99.com
                  echo "â†©ï¸  Reverted to previous configuration"
                fi
              fi
            else
              echo "âš ï¸  nginx-api-fix.conf not found, skipping nginx config update"
            fi

            # Re-enable exit-on-error
            set -e

            # ==================== SERVICE RESTART ====================
            if [ "$BACKEND_CHANGED" = true ] || [ "$FRONTEND_CHANGED" = true ]; then
              echo ""
              echo "â™»ï¸  Restarting services..."

              # Disable exit-on-error for service restarts (may not all exist)
              set +e

              # Restart PHP-FPM only if backend changed
              if [ "$BACKEND_CHANGED" = true ]; then
                systemctl restart php8.3-fpm && echo "âœ… PHP-FPM restarted" || echo "âš ï¸  PHP-FPM restart failed"
                systemctl restart laravel-reverb && echo "âœ… Reverb restarted" || echo "â„¹ï¸  Reverb service not found"
              fi

              # Reload nginx if anything changed
              systemctl reload nginx && echo "âœ… Nginx reloaded" || echo "âš ï¸  Nginx reload failed"

              # Re-enable exit-on-error
              set -e

              echo "âœ… Services restarted successfully"
            fi

            # ==================== DEPLOYMENT COMPLETE ====================
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            if [ "$BACKEND_CHANGED" = true ] && [ "$FRONTEND_CHANGED" = true ]; then
              echo "âœ… Deployment completed successfully! (Backend + Frontend)"
            elif [ "$BACKEND_CHANGED" = true ]; then
              echo "âœ… Deployment completed successfully! (Backend only)"
            elif [ "$FRONTEND_CHANGED" = true ]; then
              echo "âœ… Deployment completed successfully! (Frontend only)"
            else
              echo "âœ… Deployment completed! (No code changes - config/infra only)"
            fi
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""

            # Ensure script always exits with success (unless critical failure occurred)
            exit 0
