name: Deploy to Production

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}   # <-- your private key (PEM), no passphrase
          port: 22
          script_stop: true
          script: |
            set -e
            cd /opt/Chess-Web
            git fetch origin
            git reset --hard origin/master

            # backend (Laravel)
            cd chess-backend

            # Allow composer to run as superuser (deployment context)
            export COMPOSER_ALLOW_SUPERUSER=1

            # Install dependencies with optimizations
            composer install --no-dev --optimize-autoloader --classmap-authoritative || true

            # Run migrations
            php artisan migrate --force || true

            # Clear Laravel caches
            php artisan config:clear
            php artisan route:clear
            php artisan cache:clear
            php artisan view:clear

            composer dump-autoload --optimize 

            # Rebuild caches
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan optimize 

            # Restart queue workers
            php artisan queue:restart || echo "No queue workers running"

            # frontend (React)
            cd ../chess-frontend

            # Load NVM and use Node 20
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 20 || nvm install 20

            # Clean npm cache if needed
            npm cache clean --force || true

            # Install dependencies and build (bypass ESLint in production)
            npm ci || npm install
            DISABLE_ESLINT_PLUGIN=true CI=false npm run build

            # deploy frontend build to web server
            rsync -av --delete build/ /var/www/chess99.com/

            # Set correct permissions
            chown -R www-data:www-data /opt/Chess-Web/chess-backend/storage
            chown -R www-data:www-data /opt/Chess-Web/chess-backend/bootstrap/cache

            # Update nginx configuration for CORS
            echo "üìù Updating nginx configuration..."
            cd /opt/Chess-Web
            if [ -f nginx-api-fix.conf ]; then
              # Backup current config
              cp /etc/nginx/sites-available/api.chess99.com /etc/nginx/sites-available/api.chess99.com.backup-$(date +%Y%m%d-%H%M%S) || true
              # Copy new config
              cp nginx-api-fix.conf /etc/nginx/sites-available/api.chess99.com
              # Test nginx config
              if nginx -t 2>&1 | grep -q "successful"; then
                echo "‚úÖ Nginx configuration updated successfully"
              else
                echo "‚ö†Ô∏è  Nginx configuration test failed, reverting..."
                cp /etc/nginx/sites-available/api.chess99.com.backup-* /etc/nginx/sites-available/api.chess99.com || true
              fi
            else
              echo "‚ö†Ô∏è  nginx-api-fix.conf not found, skipping nginx config update"
            fi

            # restart services
            systemctl restart php8.3-fpm || true
            systemctl reload nginx || true
            systemctl restart laravel-reverb || echo "Reverb service not found - please create it"

            # verify services
            echo "Checking service status..."
            systemctl is-active nginx || echo "‚ùå Nginx not running"
            systemctl is-active php8.3-fpm || echo "‚ùå PHP-FPM not running"
            systemctl is-active laravel-reverb || echo "‚ö†Ô∏è  Reverb not running - WebSockets will not work"

            # Verify CORS headers (non-blocking check)
            echo ""
            echo "üîç Verifying CORS configuration..."
            # Use a more robust check that doesn't fail the deployment
            CORS_CHECK=$(curl -s -I https://api.chess99.com/storage/ 2>/dev/null || echo "FAILED")
            # Use grep without -q and redirect to /dev/null to avoid exit code issues
            if echo "$CORS_CHECK" | grep "Access-Control-Allow-Origin" > /dev/null 2>&1; then
              echo "‚úÖ CORS headers are configured correctly!"
            elif [ "$CORS_CHECK" = "FAILED" ]; then
              echo "‚ö†Ô∏è  Could not verify CORS headers - curl command failed, but deployment continues"
            else
              echo "‚ö†Ô∏è  CORS headers not detected - avatars may not load in shared images"
            fi || true

            echo ""
            echo "‚úÖ Deployment complete!"
