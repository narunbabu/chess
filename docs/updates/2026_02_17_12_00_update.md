# Fix Online Play (Color + Time Control) + Premium Board Themes

**Date**: 2026-02-17
**Type**: Feature + Bug Fix

## Context
Multiplayer games were missing time control entirely and matchmaking lacked color selection. Board themes were hardcoded to the classic green/cream style with no user customization.

## Changes

### Task 1: Fix Color + Time Control in Online Play

**Backend**:
- Added `time_control_minutes` and `increment_seconds` to Game model `$fillable`
- InvitationController now accepts and stores time control in invitation metadata, passes to game creation
- MatchmakingController accepts `preferred_color`, `time_control_minutes`, `increment_seconds` preferences
- MatchmakingService `joinQueue()` stores preferences, `createMultiplayerGame()` honors color preferences, all game creation paths include time control
- New migration: `add_preferences_to_matchmaking_queue` (preferred_color, time_control_minutes, increment_seconds columns)

**Frontend**:
- ChallengeModal: Added time control pill selector (Blitz/Rapid/Classical presets) between game mode and color choice. `onColorChoice` signature expanded to `(color, gameMode, timeControl, increment)`
- MatchmakingQueue: Added pre-search configuration screen with time control presets and color preference selection before "Find Match" button starts searching
- LobbyPage: `sendInvitation` now passes `time_control_minutes` and `increment_seconds` to API
- matchmakingService: `joinQueue()` now accepts and forwards preferences object

### Task 2: Premium Board Themes

**Backend**:
- New migration: `add_board_theme_to_users` (board_theme column, default 'classic')
- User model: Added `board_theme` to `$fillable`
- UserController: Validates and saves `board_theme` in `updateProfile()`

**Frontend**:
- New `config/boardThemes.js`: 8 themes (2 free: Classic, Blue; 6 premium: Walnut, Royal, Coral, Midnight, Forest, Marble)
- ChessBoard component: New `boardTheme` prop applies theme colors via `getTheme()` helper
- PlayComputer: Passes `user.board_theme` to ChessBoard
- PlayMultiplayer: Applies theme via `customDarkSquareStyle`/`customLightSquareStyle` on direct Chessboard usage
- Profile: New "Board Theme" section with mini board previews, lock icons for premium themes, instant save on click
- New `UpgradePrompt` component: Reusable modal for premium feature upselling

## New Files
- `chess-backend/database/migrations/2026_02_17_400000_add_preferences_to_matchmaking_queue.php`
- `chess-backend/database/migrations/2026_02_17_500000_add_board_theme_to_users.php`
- `chess-frontend/src/config/boardThemes.js`
- `chess-frontend/src/components/common/UpgradePrompt.js`

## Modified Files (12)
- `chess-backend/app/Models/Game.php`
- `chess-backend/app/Models/MatchmakingEntry.php`
- `chess-backend/app/Models/User.php`
- `chess-backend/app/Http/Controllers/InvitationController.php`
- `chess-backend/app/Http/Controllers/MatchmakingController.php`
- `chess-backend/app/Http/Controllers/UserController.php`
- `chess-backend/app/Services/MatchmakingService.php`
- `chess-frontend/src/components/lobby/ChallengeModal.jsx`
- `chess-frontend/src/components/lobby/MatchmakingQueue.jsx`
- `chess-frontend/src/pages/LobbyPage.js`
- `chess-frontend/src/services/matchmakingService.js`
- `chess-frontend/src/components/play/ChessBoard.js`
- `chess-frontend/src/components/play/PlayComputer.js`
- `chess-frontend/src/components/play/PlayMultiplayer.js`
- `chess-frontend/src/components/Profile.js`

## Risks
- Existing matchmaking entries without the new columns will use defaults (random color, 10+0 time)
- Board theme falls back to 'classic' if user has no theme set or invalid key

## Tests
- Frontend build: `pnpm build` passes
- Migrations: Both run successfully on SQLite dev DB
