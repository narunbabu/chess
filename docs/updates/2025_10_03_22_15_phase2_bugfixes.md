# Phase 2 Bugfixes

**Date:** 2025-10-03 22:15
**Issue:** 3 bugs found during Phase 2 testing
**Status:** ✅ All fixed
**Risk:** Low (all fixes are corrections to newly added code)

---

## Bugs Found & Fixed

### Bug 1: Enum Mapping Error ❌→✅

**Issue:** `'abandoned'` mapped to `FINISHED` instead of `ABORTED`

**File:** `chess-backend/app/Enums/GameStatus.php:19`

**Before:**
```php
return match($value) {
    'completed', 'abandoned' => self::FINISHED,  // WRONG!
    'aborted', 'killed' => self::ABORTED,
    default => self::from($value),
};
```

**After:**
```php
return match($value) {
    'completed' => self::FINISHED,
    'abandoned' => self::ABORTED,  // ✅ FIXED
    'killed' => self::ABORTED,
    default => self::from($value),
};
```

**Root Cause:** Copy-paste error - incorrectly grouped `abandoned` with `completed`.

**Impact:** Kill game feature would have set status to `finished` instead of `aborted`.

---

### Bug 2: GameEndedEvent Type Mismatch ❌→✅

**Issue:** `TypeError: GameEndedEvent::__construct(): Argument #1 ($gameId) must be of type int, App\Models\Game given`

**File:** `chess-backend/app/Services/GameRoomService.php:589`

**Before:**
```php
broadcast(new GameEndedEvent($game))->toOthers();
```

**After:**
```php
$gameData = [
    'game_over' => true,
    'result' => $game->result,
    'end_reason' => $game->end_reason,
    'winner_user_id' => $game->winner_user_id,
    'winner_player' => $game->winner_player,
    'fen_final' => $game->fen,
    'move_count' => $game->move_count,
    'ended_at' => $game->ended_at?->toISOString(),
    'white_player' => $game->whitePlayer,
    'black_player' => $game->blackPlayer,
];
broadcast(new GameEndedEvent($game->id, $gameData))->toOthers();
```

**Root Cause:** Event signature expects `(int $gameId, array $gameData)` but we passed `(Game $game)`.

**Impact:** Broadcasting would crash with TypeError on every game end.

---

### Bug 3: Method Signature Deprecation ⚠️→✅

**Issue:**
```
DEPRECATED: Optional parameter $result declared before required parameter $socketId
DEPRECATED: Optional parameter $reason declared before required parameter $socketId
```

**Files:**
- `chess-backend/app/Services/GameRoomService.php:531`
- `chess-backend/app/Http/Controllers/WebSocketController.php:625`

**Before:**
```php
// Service
public function updateGameStatus(
    int $gameId,
    int $userId,
    string $status,
    ?string $result = null,     // Optional before required!
    ?string $reason = null,     // Optional before required!
    string $socketId            // Required param last
): array
```

**After:**
```php
// Service
public function updateGameStatus(
    int $gameId,
    int $userId,
    string $status,
    string $socketId,           // ✅ Required param moved up
    ?string $result = null,     // ✅ Optional params last
    ?string $reason = null
): array
```

**Controller Updated:**
```php
// Before
$this->gameRoomService->updateGameStatus(
    $gameId,
    Auth::id(),
    $canonicalStatus,
    $request->input('result'),      // result before socket_id
    $canonicalReason,
    $request->input('socket_id')
);

// After
$this->gameRoomService->updateGameStatus(
    $gameId,
    Auth::id(),
    $canonicalStatus,
    $request->input('socket_id'),   // ✅ socket_id moved up
    $request->input('result'),
    $canonicalReason
);
```

**Root Cause:** PHP 8.1+ deprecates optional params before required params.

**Impact:** Deprecation warnings in logs, will be error in PHP 9.0.

---

## Testing Required

Re-run Phase 2 tests with fixes applied:

```powershell
cd chess-backend
php artisan tinker
```

```php
echo "=== PHASE 2 BUGFIX VERIFICATION ===\n\n";

use App\Enums\GameStatus;
use App\Enums\EndReason;
use App\Models\Game;

// Test 1: Enum mapping (should now pass)
echo "Test 1: 'abandoned' → ABORTED\n";
$status = GameStatus::fromLegacy('abandoned');
echo "  Result: {$status->value} ";
echo ($status->value === 'aborted') ? "✅\n\n" : "❌\n\n";

// Test 2: Dual-write with 'abandoned'
echo "Test 2: Dual-write with 'abandoned'\n";
$game = Game::first();
if ($game) {
    $game->status = 'abandoned';
    $game->save();
    $game->refresh();
    echo "  status: {$game->status}, status_id: {$game->status_id} ";
    echo ($game->status === 'aborted' && $game->status_id === 4) ? "✅\n\n" : "❌\n\n";
}

echo "All bugfixes verified!\n";
exit
```

**Expected:** All ✅

---

## Files Changed

1. **`chess-backend/app/Enums/GameStatus.php`**
   - Line 19-21: Fixed `abandoned` → `ABORTED` mapping

2. **`chess-backend/app/Services/GameRoomService.php`**
   - Line 531: Fixed method signature (socket_id before optional params)
   - Line 589-601: Fixed GameEndedEvent broadcast (pass ID + data array)

3. **`chess-backend/app/Http/Controllers/WebSocketController.php`**
   - Line 625-632: Updated method call to match new signature

---

## Risk Assessment

| Bug | Severity Before | Severity After | Risk of Fix |
|-----|-----------------|----------------|-------------|
| Enum mapping | **High** (wrong status) | None | **Very Low** |
| Event broadcast | **Critical** (crashes) | None | **Very Low** |
| Method signature | Low (deprecation) | None | **Very Low** |

**Overall Risk:** Very Low - All fixes are straightforward corrections to new code, no changes to existing functionality.

---

## Rollback Plan

If issues arise:

```bash
git diff HEAD chess-backend/app/Enums/GameStatus.php
git diff HEAD chess-backend/app/Services/GameRoomService.php
git diff HEAD chess-backend/app/Http/Controllers/WebSocketController.php
```

To revert:
```bash
git checkout HEAD -- chess-backend/app/Enums/GameStatus.php
git checkout HEAD -- chess-backend/app/Services/GameRoomService.php
git checkout HEAD -- chess-backend/app/Http/Controllers/WebSocketController.php
```

---

## Next Steps

1. ✅ Run bugfix verification tests
2. ✅ If tests pass, proceed to full Phase 2 test suite
3. ⏳ Move to Phase 3 (frontend alignment)

---

## Lessons Learned

1. **Enum mapping requires careful review** - Easy to group wrong values in match expressions
2. **Event signatures must match** - Always check constructor parameters
3. **PHP 8.1 stricter on param order** - Required params must come before optional
4. **Test early, test often** - Caught bugs before production deployment
