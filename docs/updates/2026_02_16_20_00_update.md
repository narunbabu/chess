# Lobby Revamp: Synthetic Players + Matchmaking Queue

**Date**: 2026-02-16
**Type**: Feature
**Status**: Complete (pending migration)

## Context

The /lobby page previously showed only real online users. When no humans were online, newcomers saw an empty lobby. This update adds synthetic (bot) players and a matchmaking queue.

## Changes

### Backend (6 new files, 1 modified)

**New files:**
- `migrations/2026_02_16_200000_create_synthetic_players_table.php` — Schema for 40 synthetic bot profiles
- `migrations/2026_02_16_200001_create_matchmaking_queue_table.php` — Matchmaking queue with race-condition-safe matching
- `Models/SyntheticPlayer.php` — Model with `findClosestToRating()`, `getForLobby()`, DiceBear avatar URL accessor
- `Models/MatchmakingEntry.php` — Queue entry model with user/synthetic/game relations
- `Services/MatchmakingService.php` — Core logic: `joinQueue()`, `checkStatus()` (human-first, synthetic fallback after 20s), `cancelQueue()`
- `Seeders/SyntheticPlayerSeeder.php` — 40 Indian-named bots across levels 6-16 (1370-2440 rating)
- `Controllers/LobbyController.php` — `GET /api/v1/lobby/players` returning real + synthetic players
- `Controllers/MatchmakingController.php` — `POST join`, `GET status/{id}`, `DELETE cancel/{id}`

**Modified:**
- `routes/api_v1.php` — Added 4 routes (lobby/players, matchmaking/join, status, cancel)

### Frontend (3 new files, 3 modified)

**New files:**
- `services/matchmakingService.js` — API client for lobby/matchmaking endpoints
- `components/lobby/MatchmakingQueue.jsx` — Modal overlay with spinner, 20s countdown, match result transition
- `components/lobby/FriendSearch.jsx` — Debounced user search with challenge button

**Modified:**
- `pages/LobbyPage.js` — Hero "Play Online" button, 4 tabs (Players, AI Opponents, Invitations, Active Games), fetches from new lobby API with fallback
- `pages/LobbyPage.css` — Hero section, matchmaking overlay, bot card, friend search styles
- `components/lobby/PlayersList.jsx` — Removed hardcoded "Computer" entry, humans-only display
- `components/play/PlayComputer.js` — Accepts `syntheticOpponent` from lobby, auto-sets difficulty, displays bot identity in GameContainer

## Deployment Steps

```bash
php artisan migrate
php artisan db:seed --class=SyntheticPlayerSeeder
```

## Risks

- Matchmaking `SELECT FOR UPDATE` requires MySQL/PostgreSQL (not SQLite) for proper locking
- Synthetic player seeder truncates existing data — safe for first run, use `--force` in production
- Lobby API has graceful fallback to old `/users` endpoint if new endpoint fails

## Verification

1. `GET /api/v1/lobby/players` returns 40 synthetic + real online users
2. Open /lobby → hero button visible, AI Opponents tab shows bots
3. Click "Play Online" → searching overlay → matches with bot after 20s
4. Two browsers with similar rating → matched with each other before timeout
5. Friend search → debounced results → challenge opens ChallengeModal
6. `pnpm build` compiles without errors
