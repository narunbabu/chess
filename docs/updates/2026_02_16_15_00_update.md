# 3-Tier Subscription System Implementation

**Date**: 2026-02-16
**Type**: Feature (new)
**Scope**: Backend + Frontend

## Context
Chess99 needed a recurring revenue model beyond tournament fees. Implemented a 3-tier subscription system (Free/Premium/Pro) with Razorpay integration (mock mode for now).

## Changes

### Backend — New Files (11)
- **3 Migrations**: `subscription_plans` table, users table alter (subscription fields), `subscription_payments` table
- **SubscriptionTier enum**: FREE/PREMIUM/PRO with level comparison helpers
- **SubscriptionPlan model**: Plan data with scopes, casts, feature helpers
- **SubscriptionPayment model**: Payment records following ChampionshipParticipant pattern
- **SubscriptionPlanSeeder**: Seeds 5 plans (free, premium monthly/yearly, pro monthly/yearly)
- **SubscriptionService**: Core business logic — checkout, webhook handling, mock mode, Razorpay API
- **SubscriptionController**: 5 endpoints (plans, current, checkout, cancel, webhook)
- **CheckSubscription middleware**: Tier-gating middleware (follows CheckRole pattern)
- **SyncSubscriptionStatus command**: Daily cron to expire stale subscriptions

### Backend — Modified Files (4)
- **User.php**: Added subscription relationships + helper methods (hasActiveSubscription, hasSubscriptionTier, activateSubscription, etc.)
- **routes/api.php**: Added 5 subscription routes
- **bootstrap/app.php**: Registered `subscription` middleware alias + daily sync schedule
- **AppServiceProvider.php**: Added 5 subscription gates (access-premium, access-pro, create-tournament, access-analytics, access-synthetic-opponents)

### Frontend — New Files (6)
- **SubscriptionContext.js**: State management for plans, current subscription, checkout flow
- **PricingPage.js**: Main pricing page with monthly/yearly toggle, 3 plan cards, feature comparison table
- **PricingCard.jsx**: Individual plan card with tier-specific colors (gray/gold/purple)
- **RazorpayCheckout.jsx**: Checkout modal (mock auto-completes, real mode loads Razorpay SDK)
- **SubscriptionManagement.jsx**: Current subscription display with cancel flow
- **Subscription.css**: Full styling using Chess99 design tokens

### Frontend — Modified Files (1)
- **App.js**: Added SubscriptionProvider, /pricing route, /account/subscription route

## Tiers & Pricing
| Tier | Monthly | Yearly | Key Features |
|------|---------|--------|-------------|
| Free | ₹0 | — | 5 undos, basic stats, ads |
| Premium | ₹99 | ₹999 | Ad-free, unlimited undos, full stats, priority matchmaking |
| Pro | ₹499 | ₹4999 | All Premium + tournaments, analytics, synthetic opponents |

## API Endpoints
- `GET /api/subscriptions/plans` (public)
- `GET /api/subscriptions/current` (auth)
- `POST /api/subscriptions/checkout` (auth)
- `POST /api/subscriptions/cancel` (auth)
- `POST /api/subscriptions/webhook` (public)

## Verification
- ✅ Migrations run successfully (3 tables)
- ✅ Seeder populates 5 plans
- ✅ All 5 routes registered
- ✅ Frontend build compiles successfully
- ✅ Daily cron scheduled at 02:00 UTC

## Risks
- Razorpay plan IDs must be created on dashboard before disabling mock mode
- Webhook signature verification only active in non-mock mode
- Grace period: 3 days after subscription_expires_at before downgrade

## Rollout
- Feature ships in mock mode (no real payments)
- Enable by setting `RAZORPAY_MOCK_MODE=false` in .env + creating plans on Razorpay
